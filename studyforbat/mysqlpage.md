##Innodb数据页  

####页概念
1. Innodb是将表中数据存储在磁盘上的数据引擎，所以即使关机重启数据也还会存在  
2. 因为数据操作都是在内存进行的，如果有写入或者更新操作，需要先从磁盘逐条读  
数据，这样会降低操作速度  
3. Innodb：将数据划分为若干页，以页作为磁盘和内存交换的基本单位，页大小一般  
为16kb，每次读取的时候最少读取一页，内存刷新到磁盘的时候最少要也是一页  
4. 数据页按功能分为不同的类型  
    1. 存放表空间头部信息的页
    2. 存放Insert buffer的页
    3. 存放数据记录的页，这也是我们常用的  

####页中数据记录存放  
页创建的时候会分为不同部分，而我们创建的数据则会存放在User Record部分。页刚  
创建时并没有这部分，每当我们插入一条数据时，会从Free Space申请一记录大小的空  
间给User Record部分。如果Free Space完全被User Record取代后仍有新纪录插入的话，  
则会创建新的页  
![页结构!](/studyforbat/pic/page.png "页")  

####记录（数据）的组成  
|名称   |大小(bit)   |描述   |
|---|---|---|
|预留位1   |1  |未使用   |
|预留位2   |1   |未使用   |
|delete_mask|1  |标记该记录是否被删除   |
|min_rec_mask   |1   |B+树非叶子节点最小记录都会添加该标记   |
|n_owned   |4   |当前记录拥有的记录数   |
|heap_no   |13   |表示当前记录在记录堆中的位置信息   |
|record_type   |3   |记录类型   |
|next_record   |16   |下一条记录的相对位置  
- delete_mask  
    - 记录删除的时候并不会从页中删除，只是进行标记。这是因为如果移除的话会造成  
    其他数据的重排序，影响性能。标记删除的记录会组成所谓的垃圾链表，占用的空间  
    是可重用空间。如果有新的数据插入的话，会把这部分空间覆盖掉。
- heap_no
    - 每条记录在页中的位置，也可以说是序号。Innodb会自动为每个页插入两条记录，  
    一个是最小记录，一个是最大记录，序号是0和1大小比较的是主键的大小。由于这  
    两条记录并不是我们插入的，所以并不在User Record部分  
- record_type  
    - 记录类型  
- next_record  
    - 从当前记录的真实数据到下一条记录真实数据的偏移量。下一条记录并不是插入  
    顺序的下一条，而是主键大小比较的下一条。最小记录的下一条就是主键最小的用  
    户记录，主键值最大的记录的下一条为最大记录。这样我们的记录会按主键由小到  
    大形成单链表   
    ![Next_Record!](/studyforbat/pic/next_record.png "Next_Record")   
    - 删除操作后  
    ![delete!](/studyforbat/pic/del_record.png "删除")  
    - 重新插入删除的数据  
    ![insert!](/studyforbat/pic/insert_record.png "插入")  

####页目录
- 生成过程
    - 将所有的记录（包括最大和最小，但不包括标记为删除）分为若干组
    - 将每组最后一条记录也就是最大的那条n_owned属性设置为该组有几条记录
    - 将每组最后一条记录的地址偏移量取出来，按顺序存储到靠近页尾部的地方，这个地方就是页目录
        - 最小记录的n_owned属性为1，自成一组。
        - 最大记录的该属性为5，如图  
        ![dir!](/studyforbat/pic/page_dir.png "结构")  
- 规则
    - 最小记录自成一组
    - 最大记录组内1-8条数据
    - 其他组4-8条
- 插入  
    - 初始时有两个组，最小和最大记录所在组
    - 插入时找到大于该数据主键值并且差值最小所在的槽，将该槽对应的n_owned加一
    - 如果该属性大于8，则拆分为两个组，一个组4，一个组5.在页目录添加相应槽记录
- 查找
    - 通过二分法确定所在槽位，找到该槽中最小记录（上一槽位最大记录next_record指向的）
    - 通过next_record遍历找到该记录
####Page Header
主要针对数据页。主要维护页元数据，记录数以及槽位数等  

#####File Header  
通用部分，维护页编号，上一页下一页等信息，所有页会组成双链表  

####File Trailer  
当内存页刷磁盘的时候，检验页数据的完整性